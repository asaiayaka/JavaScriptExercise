<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>ex08</title>
        <style>
            .body { font-family: sans-serif; padding: 20px;}
            .req-box { margin-bottom: 15px; }
            .req-box input { width: 200px; }
            .result { margin-left: 10px; font-weight: bold; }
        </style>    
    </head>
    <body>
        <h1>WebSocket リクエスト送信テスト</h1>

        <!-- 複数行の入力を用意 -->
         <div id="requests">
            <div class="req-box">
                <input type="text" class="req-input" value="Alice" />
                <button class="send-btn">送信</button>
                <span class="result"></span>
            </div>

            <div class="req-box">
                <input type="text" class="req-input" value="Bob" />
                <button class="send-btn">送信</button>
                <span class="result"></span>
            </div>

            <div class="req-box">
                <input type="text" class="req-input" value="Charlie" />
                <button class="send-btn">送信</button>
                <span class="result"></span>
            </div>
         </div>

         <script>
            // ブラウザ側のsendRequest
            // WebSocketを接続開始
            const ws = new WebSocket("ws://localhost:3003");

            // 複数のリクエストを区別するためのpendingRequests
            const pendingRequests = new Map();

            // メッセージ受信時の処理
            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    const { id, response } = msg;

                    // リクエストに対応するPromiseをresolve
                    if (pendingRequests.has(id)) {
                        const { resolve, timer } = pendingRequests.get(id);
                        clearTimeout(timer);
                        resolve(response);
                        pendingRequests.delete(id);
                    }
                } catch (e) {
                    // JSONではないものは無視
                }
            };

            // リクエストを送信する関数
            function sendRequest(body, timeout = 5000) {
                return new Promise((resolve, reject) => {
                    if (ws.readyState !== WebSocket.OPEN) {
                        reject("WebSocket 未接続");
                        return;
                    }

                    const id = crypto.randomUUID();
                    const timer = setTimeout(() => {
                        pendingRequests.delete(id);
                        reject("タイムアウト");
                    }, timeout);

                    pendingRequests.set(id, { resolve, reject, timer });

                    // JSON形式で送信
                    ws.send(JSON.stringify({ id, request: body }));
                });
            }

            // UIイベント処理
            document.querySelectorAll(".send-btn").forEach((btn, index) => {
                btn.addEventListener("click", async () => {
                    const input = document.querySelectorAll(".req-input")[index];
                    const result = document.querySelectorAll(".result")[index];

                    result.textContent = "送信中...";

                    try {
                        const response = await sendRequest(input.value);
                        result.textContent = "→ " + response;
                    } catch (err) {
                        result.textContent = "エラー: " + err;
                    }
                });
            });
         </script>
    </body>
</html>